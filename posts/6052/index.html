

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/blog/img/favicon.png">
  <link rel="icon" href="/blog/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="呵呵君">
  <meta name="keywords" content="">
  
    <meta name="description" content="阅读一下i山大源码">
<meta property="og:type" content="article">
<meta property="og:title" content="i山大APP源码解读">
<meta property="og:url" content="http://47.100.74.245/blog/posts/6052/index.html">
<meta property="og:site_name" content="苏喂">
<meta property="og:description" content="阅读一下i山大源码">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-07-29T23:13:58.535Z">
<meta property="article:modified_time" content="2022-07-29T23:13:58.535Z">
<meta property="article:author" content="呵呵君">
<meta property="article:tag" content="Flutter">
<meta name="twitter:card" content="summary_large_image">
  
  
  <title>i山大APP源码解读 - 苏喂</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      
        
          
          
          
        
        <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css" />
      
      
        <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/line-numbers/prism-line-numbers.min.css" />
      
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/blog/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"47.100.74.245","root":"/blog/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"5b545cafb70936459694733c37bcf02c","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/blog/local-search.xml"};
  </script>
  <script  src="/blog/js/utils.js" ></script>
  <script  src="/blog/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/blog/">
      <strong>苏喂</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/blog/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/blog/img/banner.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="i山大APP源码解读">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-07-29 23:13" pubdate>
        2022年7月29日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      20k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      171 分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">i山大APP源码解读</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：几秒前
                
              </p>
            
            <div class="markdown-body">
              <h2 id="概览">概览</h2>
<h3 id="目录结构">目录结构</h3>
<div class="code-wrapper"><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">├── api
│   ├── api.dart
│   ├── channel.dart
│   ├── event.dart
│   ├── request
│   │   ├── app_exceptions.dart
│   │   ├── http_request.dart
│   │   ├── http_utils.dart
│   │   └── interceptor
│   │       ├── cache_interceptor.dart
│   │       ├── error_interceptor.dart
│   │       ├── link_change_interceptor.dart
│   │       ├── request_interceptor.dart
│   │       └── retry_interceptor.dart
│   ├── server.dart
│   ├── todo_api.dart
│   └── wss.dart
├── bean
│   ├── bean.dart
│   ├── message_enum.dart
│   ├── result_entity.dart
│   ├── themes.dart
│   └── todo
│       ├── calendar_event.dart
│       ├── calendar_event.g.dart
│       ├── schedule_entity.dart
│       ├── schedule_entity.g.dart
│       ├── todo_item.dart
│       └── todo_item.g.dart
├── dialog
│   ├── label_choose_dialog.dart
│   ├── loading_dialog.dart
│   ├── notifacation_dialog.dart
│   ├── text_field_dialog.dart
│   └── todo_event_dialog.dart
├── main.dart
├── route
│   └── route_table.dart
├── settings
│   └── color_scheme.dart
├── ui
│   ├── about.dart
│   ├── academic.dart
│   ├── accountbill.dart
│   ├── activity.dart
│   ├── activityview.dart
│   ├── announce.dart
│   ├── attachment.dart
│   ├── audit_course.dart
│   ├── calendar.dart
│   ├── chat.dart
│   ├── courseselect.dart
│   ├── education_plan.dart
│   ├── evaluate.dart
│   ├── exam.dart
│   ├── feedback.dart
│   ├── grade.dart
│   ├── history.dart
│   ├── image.dart
│   ├── library.dart
│   ├── login.dart
│   ├── main.dart
│   ├── main_news.dart
│   ├── main_user.dart
│   ├── map.dart
│   ├── minor_login.dart
│   ├── minor_manage.dart
│   ├── more.dart
│   ├── news.dart
│   ├── origin.dart
│   ├── phone.dart
│   ├── privacy.dart
│   ├── schoolbus.dart
│   ├── search.dart
│   ├── settings.dart
│   ├── studyroom.dart
│   ├── timetable.dart
│   ├── todolist.dart
│   ├── tools
│   │   ├── code_conversion.dart
│   │   ├── force_exit.dart
│   │   ├── random_choose.dart
│   │   ├── reflection_test.dart
│   │   └── tools.dart
│   ├── user.dart
│   ├── volunteer.dart
│   └── yb.dart
├── util
│   ├── cache_util.dart
│   ├── clipboard_util.dart
│   ├── comm.dart
│   ├── converter.dart
│   ├── course_api_channel.dart
│   ├── database_util.dart
│   ├── device_info.dart
│   ├── device_info_util.dart
│   ├── font_util.dart
│   ├── global_message.dart
│   ├── icon_util.dart
│   ├── image.dart
│   ├── intercept_single.dart
│   ├── log_util.dart
│   ├── notification.dart
│   ├── notification_util.dart
│   ├── package_info_util.dart
│   ├── path_util.dart
│   ├── permission_util.dart
│   ├── platform_util.dart
│   ├── security_util.dart
│   ├── sentry_util.dart
│   ├── sharedpreference_util.dart
│   ├── shortcuts_util.dart
│   ├── store.dart
│   ├── string_util.dart
│   └── ws.dart
└── widget
    ├── app_bar.dart
    ├── cards.dart
    ├── constants.dart
    ├── delegate_builder.dart
    ├── function_widget.dart
    ├── head_image.dart
    ├── html_widget.dart
    ├── list_title_switch.dart
    ├── marquee_text.dart
    ├── rich_text.dart
    ├── sducalendar.dart
    ├── shape.dart
    ├── toast.dart
    └── view_image.dart
</code></pre></div>
<p>i山大目录有以下几个主目录</p>
<ul>
<li>api: 网络api。</li>
<li>bean: 实体类。</li>
<li>dialog: 封装后的提醒事项。</li>
<li>route: 存放路由表。</li>
<li>settings: 已废弃，用于配置配色。</li>
<li>ui: 构建UI。</li>
<li>util: 缓存管理、粘贴板管理等工具。</li>
<li>widget: 存放自行封装的卡片、富文本等Widget。</li>
</ul>
<h3 id="依赖情况">依赖情况</h3>
<div class="code-wrapper"><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">dependencies:
  flutter:
    sdk: flutter
  flutter_localizations:
    sdk: flutter

  dio: ^4.0.0
  sqflite: ^2.0.2
  path_provider: ^2.0.9
  shared_preferences: ^2.0.5
  url_launcher: ^6.0.10
  flutter_slidable: ^1.3.0
  image_picker: ^0.7.4
  file_picker: ^4.5.1
  flutter_downloader: ^1.6.0-nullsafety.0
  event_bus: ^1.1.0
  photo_view: ^0.4.2
  marquee: ^1.6.1
  date_format: ^1.0.8
  flutter_sticky_header: ^0.6.1
  web_socket_channel: ^1.0.13
  flutter_speed_dial: ^6.0.0
  pull_to_refresh: ^2.0.0
  # for update
  flutter_local_notifications: ^5.0.0+4
  permission_handler: ^7.1.0
  share_plus: ^4.0.9
  device_info_plus: ^3.2.2
  # 只有这个版本可以
  package_info_plus: &#39;1.3.0&#39;
  hive: ^2.1.0
  hive_flutter: ^1.1.0
  smooth_page_indicator: ^0.2.0
  material_floating_search_bar: ^0.2.6
  flutter_inappwebview: ^5.3.2
  amap_flutter_map: ^2.0.1
  reorderables: ^0.5.0
  get: ^4.6.5
  expansion_tile_card: ^2.0.0
  quick_actions: ^0.6.0+2
  connectivity_plus: ^1.1.0
  # 格式化日期时间等
  intl: ^0.17.0
  path: ^1.8.0
  fl_chart: ^0.55.0
  sentry_flutter: ^6.6.0
  json_serializable: ^3.5.1
  json_annotation: ^3.1.1
  r_calendar: ^0.1.11
  # for news
  flutter_widget_from_html_core: ^0.8.5+3
  fwfh_selectable_text: ^0.8.3
  sanitize_html: ^2.0.0
  image: ^3.1.3
  flutter_breadcrumb: ^1.0.1
  bottom_sheet: ^3.1.1
  flutter_staggered_animations: ^1.0.0
  flutter_staggered_grid_view: ^0.6.1

  # for desktop
  bot_toast: ^4.0.2
  extended_image: ^6.2.1

  # The following adds the Cupertino Icons font to your application.
  # Use with the CupertinoIcons class for iOS style icons.
  cupertino_icons: ^1.0.0

dev_dependencies:
  build_runner: ^1.10.4
  msix: ^3.1.4
  flutter_test:
    sdk: flutter</code></pre></div>
<h3 id="app启动流程">APP启动流程</h3>
<p>观摩一下<code>main.dart</code></p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">&#x2F;&#x2F;捕获Flutter框架异常
Future&lt;Null&gt; main() async &#123;
  WidgetsFlutterBinding.ensureInitialized();
  await initialize();
  FlutterError.onError &#x3D; (FlutterErrorDetails details) async &#123;
    if (isInDebugMode) &#123;
      FlutterError.dumpErrorToConsole(details);
    &#125; else &#123;
      Zone.current.handleUncaughtError(details.exception, details.stack);
    &#125;
  &#125;;

  &#x2F;&#x2F; ...

&#125;</code></pre></div>
<p>首先注意到<code>WidgetsFlutterBinding.ensureInitialized();</code>这条语句，在讨论他之前，需要看一下一个Flutter项目是如何跑起来的。</p>
<p>众所周知，Flutter的入口也是<code>main()</code>函数，并在内部调用<code>runApp()</code>方法装载Widget。这个机制给出了一种问题的解决：</p>
<p>当App启动需要进行数据加载或网络请求时，可以使用多次运行<code>runApp()</code>的方式建立一个空白的等待页<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="Flutter runApp -- WidgetsFlutterBinding - 掘金
">[1]</span></a></sup></p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">void main() &#123;
  runApp(const SplashScreen());

  Future.delayed(Duration(seconds: 10), () &#123;
       runApp(const MyApp());
   &#125;);
&#125;</code></pre></div>
<p>至于<code>runApp()</code>函数，可以查看他的源码</p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">void runApp(Widget app) &#123;
  WidgetsFlutterBinding.ensureInitialized()
  ..scheduleAttachRootWidget(app)
  ..scheduleWarmUpFrame();
&#125;
&#96;&#96;&#96;&#96;

一共有三个阶段组成

1. &#96;WidgetsFlutterBinding&#96;初始化（&#96;ensureInitialized()&#96;）,与 &#96;Flutter Engine&#96; 进行通信。
2. 绑定根节点创建flutter著名的三棵树（&#96;scheduleAttachRootWidget(app)&#96;）进行布局。
3. 将布局出来的树进行渲染（&#96;scheduleWarmUpFrame()&#96;）

另外参考StackOverflow上的一个回答：

The above image is the architecture layers of Flutter, the &#96;WidgetFlutterBinding&#96; is used to **interact with the Flutter engine**. &#96;Firebase.initializeApp()&#96; needs to call native code to initialize Firebase, and since the plugin needs to use platform channels to call the native code, which is done asynchronously therefore you have to call &#96;ensureInitialized()&#96; to **make sure that you have an instance** of the &#96;WidgetsBinding&#96;<sup id="fnref:2" class="footnote-ref"><a href="#fn:2" rel="footnote"><span class="hint--top hint--rounded" aria-label="What Does WidgetsFlutterBinding.ensureInitialized() do? - StackOverflow
">[2]</span></a></sup>.

之后会异步调用&#96;initialize()&#96;方法。

接下来调用&#96;FlutterError.onError()&#96;方法捕获异常。所有 Flutter 的错误均会被回调方法 &#96;FlutterError.onError&#96; 捕获。默认情况下，会调用 &#96;FlutterError.presentError&#96; 方法，并将错误转储到当前的设备日志中。当从 IDE 运行应用时，检查器重写了该方法，错误也被发送到 IDE 的控制台，可以在控制台中检查出错的对象<sup id="fnref:3" class="footnote-ref"><a href="#fn:3" rel="footnote"><span class="hint--top hint--rounded" aria-label="在Flutter里处理错误
">[3]</span></a></sup>。

例如，如果你想在 release 模式下发生错误时立刻关闭应用，可以使用下面的回调方法:

&#96;&#96;&#96;dart
void main() &#123;
  FlutterError.onError &#x3D; (FlutterErrorDetails details) &#123;
    FlutterError.presentError(details);
    if (kReleaseMode)
      exit(1);
  &#125;;
  runApp(MyApp());
&#125;</code></pre></div>
<p>i山大将判断是否为<code>debug</code>模式，若是则直接输出到console，否则的话调用<code>Zone.current.handleUncaughtError(details.exception, details.stack)</code></p>
<p>接下来在<code>Zone</code>中捕获其他异常，并使用Sentry发送到报错平台</p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">runZonedGuarded(
  () &#123;
    SentryFlutter.init((options) &#123;
      options
        ..dsn &#x3D;
            &#39;http:&#x2F;&#x2F;61f9001280de456f8cadd3b013ad2fff@sentry.swsdu.online:9000&#x2F;2&#39;;
      options.debug &#x3D; isInDebugMode;
      options.useFlutterBreadcrumbTracking();
      options.beforeSend &#x3D; beforeSend;
    &#125;, appRunner: () &#x3D;&gt; runApp(ISDUApp()));
  &#125;,
  (exception, stackTrace) &#123;
     _reportError(exception, stackTrace);
  &#125;,
);</code></pre></div>
<p>下面添加发送报错前的信息</p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">&#x2F;&#x2F;&#x2F; 发送错误前插入用户学号信息以及ip信息
FutureOr&lt;SentryEvent&gt; beforeSend(SentryEvent event, &#123;dynamic hint&#125;) async &#123;
  event &#x3D; event.copyWith(
      user: SentryUser(
          username: UserAPI.curUser?.casId ?? &#39;none&#39;, ipAddress: &#39;&#123; &#123;auto&#125; &#125;&#39;));
  return event;
&#125;</code></pre></div>
<p>顺便还有这两个函数</p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">&#x2F;&#x2F;反馈异常
void _reportError(Object exception, StackTrace stackTrace) async &#123;
  LogUtil.log(exception, name: &#39;_reportError&#39;);
  Sentry.captureException(exception, stackTrace: stackTrace);
&#125;

bool get isInDebugMode &#123;
  &#x2F;&#x2F; 之前用的assert,感觉不够高级,还是这个好
  return kDebugMode;
&#125;</code></pre></div>
<p>下面是<code>main()</code>中调用的<code>initialize()</code>的细节</p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">&#x2F;&#x2F;&#x2F;初始化启动服务
Future&lt;void&gt; initialize() async &#123;
  &#x2F;&#x2F;并行初始化
  await Future.wait([
    Store.initialize(),
    SharedPreferenceUtil.initialize(),
    PackageInfoUtil.initialize(),
    DeviceInfoUtil.initialize()
  ]);
  &#x2F;&#x2F; 下面务必在SharePreferenceUtil初始化完成后执行
  &#x2F;&#x2F;加载原生channel
  NativeChannel.initialize();
  &#x2F;&#x2F; 加载字体
  await FontUtil.initialize();
  HttpUtils.init(
      baseUrl: Server.baseHost, connectTimeout: 7500, receiveTimeout: 7500);
  if (PlatformUtil.isMobile) &#123;
    await FlutterDownloader.initialize(debug: false);
  &#125;
&#125;</code></pre></div>
<p>最后是整个App的Widget，首先<code>new</code>了个<code>botToastBuilder</code>用于生成提醒。然后是初始化设置函数</p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">&#x2F;&#x2F;&#x2F;初始化设置
void initSetting() &#123;
  &#x2F;&#x2F; 初始化SharedPreference
  SharedPreferences s &#x3D; SharedPreferenceUtil.instance;
  &#x2F;&#x2F; 初始化控制缓存状态的参数
  if (s.getBool(SharedPreferenceUtil.CACHE_EXAM) &#x3D;&#x3D; null) &#123;
    s.setBool(SharedPreferenceUtil.CACHE_EXAM, true);
  &#125;
  if (s.getBool(SharedPreferenceUtil.CACHE_SCHEDULE) &#x3D;&#x3D; null) &#123;
    s.setBool(SharedPreferenceUtil.CACHE_SCHEDULE, true);
  &#125;
  &#x2F;&#x2F; 初始化偏好功能的默认菜单
  if (s.getStringList(SharedPreferenceUtil.FAVOR_FUNCTION) &#x3D;&#x3D; null) &#123;
    s.setStringList(
        SharedPreferenceUtil.FAVOR_FUNCTION, [&#39;图书馆&#39;, &#39;自习室&#39;, &#39;校车&#39;]);
  &#125;
&#125;

@override
StatelessElement createElement() &#123;
  &#x2F;&#x2F;获取通知列表
  NotificationUtil.initNotification();
  &#x2F;&#x2F; 加载用户信息
  UserAPI.fetchUserInformationString();
  &#x2F;&#x2F;初始化WebSocket
  ChatWebSocket.initialize();
  initSetting();
  return super.createElement();
&#125;</code></pre></div>
<p>最后，<code>build()</code></p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">@override
Widget build(BuildContext context) &#123;
  return GetMaterialApp(
    title: &#39;i山大&#39;,
    &#x2F;&#x2F;去除debug标志
    debugShowCheckedModeBanner: false,
    &#x2F;&#x2F;支持自定义字体
    theme: FontUtil.merge(Themes.themeNow),
    &#x2F;&#x2F;适配手机暗夜模式
    darkTheme: Themes.darkTheme,
    &#x2F;&#x2F;添加国际化支持
    localizationsDelegates: [
      GlobalMaterialLocalizations.delegate,
      GlobalWidgetsLocalizations.delegate,
      GlobalCupertinoLocalizations.delegate,
    ],
    supportedLocales: [
      const Locale(&#39;zh&#39;, &#39;CN&#39;),
      const Locale(&#39;en&#39;, &#39;US&#39;),
    ],
    locale: Locale(&#39;zh&#39;),
    onGenerateRoute: RouteTable.generateRoute,
      builder: (context, child) &#123;
      double scale &#x3D; SharedPreferenceUtil.instance
                .getDouble(SharedPreferenceUtil.TEXT_SCALE) ??
            1;
      return MediaQuery(
        key: UniqueKey(),
        data: MediaQuery.of(context).copyWith(textScaleFactor: scale),
        child: botToastBuilder(context, child),
      );
    &#125;,
    navigatorObservers: [
      SentryNavigatorObserver(),
      BotToastNavigatorObserver(),
    ],
    home: MainPage());
&#125;</code></pre></div>
<h4 id="关于widgetsflutterbinding">关于WidgetsFlutterBinding</h4>
<p><code>WidgetsFlutterBinding</code>将是Widget架构和Flutter Engine连接的核心桥梁，也是整个Flutter应用层的核心。通过 <code>ensureInitialized()</code> 方法我们可以得到<strong>一个全局单例</strong><code>WidgetsFlutterBinding</code><sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="Flutter runApp -- WidgetsFlutterBinding - 掘金
">[1]</span></a></sup>。</p>
<p>有时候我们会在发现有的app在在<strong>运行应用程序之前先与Flutter Engine进行通信</strong>，所以要先将<code>WidgetsFlutterBinding.ensureInitialized()</code>提前。</p>
<p>稍微解释一下各种Binding的作用。</p>
<ul>
<li><code>ServicesBinding</code>：Flutter System 平台消息监听绑定类。即Platform与Flutter Layer通信相关服务，同时注册并监听应用生命周期回调。</li>
<li><code>SchedulerBinding</code>：Flutter 绘制调度器相关绑定类，调试统计绘制过程持续时间等编译模式下的操作。</li>
<li><code>GestureBinding</code>：Flutter Gesture事件绑定，处理屏幕事件分发和事件回调，其初始化方法的关键点是回调事件处理<code>_handlePointerDataPacket</code>函数被赋值给window的属性，以便window在接收到屏幕事件后调用，window的实例是 Framework Layer 和 Engine 桥接层用来处理屏幕事件。</li>
<li><code>RendererBinding</code>：引擎之间的渲染树和Flutter Binding类，内部重点是持有渲染树的根节点。</li>
<li><code>SemanticsBinding</code>：引擎之间的语义树和 Flutter Binding 类。</li>
</ul>
<h4 id="使用zone捕获并处理异常">使用<code>Zone</code>捕获并处理异常</h4>
<p>Zone表示一个代码执行的环境范围，为了方便理解，读者可以将Zone类比为一个代码执行沙箱，不同沙箱的之间是隔离的，沙箱可以捕获、拦截或修改一些代码行为，如Zone中可以捕获日志输出、Timer创建、微任务调度的行为，同时Zone也可以捕获所有未处理的异常<sup id="fnref:4" class="footnote-ref"><a href="#fn:4" rel="footnote"><span class="hint--top hint--rounded" aria-label="Flutter异常捕获
">[4]</span></a></sup>。Dart中有一个<code>runZoned()</code>方法，可以给执行对象指定一个Zone。</p>
<p>在Flutter中，还有一些Flutter没有为我们捕获的异常，如调用空对象方法异常、Future中的异常。在Dart中，异常分两类：同步异常和异步异常，同步异常可以通过try/catch捕获，而异步异常则比较麻烦，如下面的代码是捕获不了Future的异常的:</p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">try&#123;
    Future.delayed(Duration(seconds: 1)).then((e) &#x3D;&gt; Future.error(&quot;xxx&quot;));
&#125;catch (e)&#123;
    print(e)
&#125;</code></pre></div>
<p>如果你想捕获这样的错误，请使用 <code>runZonedGuarded()</code>。</p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">void main() &#123;
  runZonedGuarded(() &#123;
    runApp(MyApp());
  &#125;, (Object error, StackTrace stack) &#123;
    myBackend.sendError(error, stack);
  &#125;);
&#125;</code></pre></div>
<blockquote>
<p>请注意，如果你的应用在 <code>runApp</code> 中调用了 <code>WidgetsFlutterBinding.ensureInitialized()</code> 方法来进行一些初始化操作（例如 <code>Firebase.initializeApp()</code>），则必须在 runZonedGuarded 中调用 <code>WidgetsFlutterBinding.ensureInitialized()</code></p>
</blockquote>
<h2 id="路由">路由</h2>
<p><code>RouteTable</code>类维护一个<code>Map</code>作为路由表</p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">&#x2F;&#x2F;路由界面a-z排序
  static Map&lt;String, WidgetBuilder&gt; _routes &#x3D; &#123;
    &#x2F;&#x2F;主界面
    &#39;&#x2F;&#39;: (context) &#x3D;&gt; MainPage(),
    &#x2F;&#x2F;教务
    &#39;academic_page&#39;: (context) &#x3D;&gt; AcademicPage(),
    &#x2F;&#x2F; ...
    &#x2F;&#x2F;志愿查询
    &#39;volunteer_page&#39;:(context) &#x3D;&gt; VolunteerPage(),
  &#125;;</code></pre></div>
<p>以及一个鉴权拦截表，用于判断页面是否需要登录</p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">&#x2F;&#x2F;鉴权拦截表
static Map&lt;String, bool&gt; _needLogin &#x3D; &#123;
  &#x2F;&#x2F;主界面
  &#39;&#x2F;&#39;: false,
  &#x2F;&#x2F;教务
  &#39;academic_page&#39;: true,
  &#x2F;&#x2F; ...
  &#x2F;&#x2F;志愿查询
  &#39;volunteer_page&#39;: true,
&#125;;</code></pre></div>
<p>这里需要插入介绍<code>MaterialApp</code>接受的<code>onGenerateRoute</code>参数。它可以传参，相比于命名路由，可以多做一些相关的拦截<sup id="fnref:6" class="footnote-ref"><a href="#fn:6" rel="footnote"><span class="hint--top hint--rounded" aria-label="Flutter onGenerateRoute 路由管理 - CSDN
">[6]</span></a></sup>，比如<sup id="fnref:7" class="footnote-ref"><a href="#fn:7" rel="footnote"><span class="hint--top hint--rounded" aria-label="给特定的 route 传参 - Flutter
">[7]</span></a></sup></p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">MaterialApp(
  &#x2F;&#x2F; Provide a function to handle named routes.
  &#x2F;&#x2F; Use this function to identify the named
  &#x2F;&#x2F; route being pushed, and create the correct
  &#x2F;&#x2F; Screen.
  onGenerateRoute: (settings) &#123;
    &#x2F;&#x2F; If you push the PassArguments route
    if (settings.name &#x3D;&#x3D; PassArgumentsScreen.routeName) &#123;
      &#x2F;&#x2F; Cast the arguments to the correct
      &#x2F;&#x2F; type: ScreenArguments.
      final args &#x3D; settings.arguments as ScreenArguments;

      &#x2F;&#x2F; Then, extract the required data from
      &#x2F;&#x2F; the arguments and pass the data to the
      &#x2F;&#x2F; correct screen.
      return MaterialPageRoute(
        builder: (context) &#123;
          return PassArgumentsScreen(
            title: args.title,
            message: args.message,
          );
        &#125;,
      );
    &#125;
    &#x2F;&#x2F; The code only supports
    &#x2F;&#x2F; PassArgumentsScreen.routeName right now.
    &#x2F;&#x2F; Other values need to be implemented if we
    &#x2F;&#x2F; add them. The assertion here will help remind
    &#x2F;&#x2F; us of that higher up in the call stack, since
    &#x2F;&#x2F; this assertion would otherwise fire somewhere
    &#x2F;&#x2F; in the framework.
    assert(false, &#39;Need to implement $&#123;settings.name&#125;&#39;);
    return null;
  &#125;,
)</code></pre></div>
<p>因此路由表提供了一个方法生成一系列路由并进行鉴权</p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">static Route generateRoute(RouteSettings settings) &#123;
  &#x2F;&#x2F; 路由名称未出现在路由表里,返回空界面
  if (!_routes.containsKey(settings.name)) &#123;
    return MaterialPageRoute(
        builder: (_) &#x3D;&gt; Scaffold(
          appBar: AppBar(title: Text(&#39;Not fount&#39;),),
              body: Center(
                child: Text(&#39;No route defined for $&#123;settings.name&#125;&#39;),
              ),
            ));
  &#125;
  if (UserAPI.curUser &#x3D;&#x3D; null &amp;&amp; (_needLogin[settings.name] ?? false)) &#123;
    return MaterialPageRoute(
        builder: (context) &#x3D;&gt; LoginPage(), settings: settings);
  &#125; else &#123;
    return MaterialPageRoute(
        builder: _routes[settings.name], settings: settings);
  &#125;
&#125;</code></pre></div>
<h2 id="网络api">网络API</h2>
<p><code>api</code>包下结构是这个样子</p>
<div class="code-wrapper"><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">├── api.dart
├── channel.dart
├── event.dart
├── request
│   ├── app_exceptions.dart
│   ├── http_request.dart
│   ├── http_utils.dart
│   └── interceptor
│       ├── cache_interceptor.dart
│       ├── error_interceptor.dart
│       ├── link_change_interceptor.dart
│       ├── request_interceptor.dart
│       └── retry_interceptor.dart
├── server.dart
├── todo_api.dart
└── wss.dart</code></pre></div>
<h3 id="api及相关类">api及相关类</h3>
<p>i山大在<code>server.dart</code>文件中管理服务器信息</p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">
class Server &#123;
  static SharedPreferences _sharedPreferences;

  static final String hostSub &#x3D; &quot;https:&#x2F;&#x2F;sduonline.cn&#x2F;isdudb_main&quot;;
  static final String hostMainStatic &#x3D; &quot;https:&#x2F;&#x2F;sduonline.cn&#x2F;isduapp_static&quot;;

  static final String calendarConfigUrl &#x3D; &quot;https:&#x2F;&#x2F;widealpha.top&#x2F;xl.config&quot;;

  static final String wsServer &#x3D; &#39;wss:&#x2F;&#x2F;sduonline.cn&#x2F;wss&#x2F;&#39;;

  &#x2F;* **********************************
   *下面的是2020新接口的host
   ********************************** *&#x2F;
  &#x2F;&#x2F;主站域名,更新这个的时候一定要把..&#x2F;android&#x2F;ui&#x2F;ScheduleWidgetService里的变量一并更改
  static const List&lt;String&gt; baseHostList &#x3D; [
    &quot;https:&#x2F;&#x2F;inner.sduonline.cn&quot;, &#x2F;&#x2F;内网线路
    &quot;https:&#x2F;&#x2F;sduonline.cn&quot;, &#x2F;&#x2F;外网线路一
    &quot;https:&#x2F;&#x2F;isdu.swsdu.online&quot;, &#x2F;&#x2F;外网线路二
  ];
  &#x2F;&#x2F; 以下用于构建URL
  static String baseHost &#x3D; &quot;https:&#x2F;&#x2F;sduonline.cn&quot;;
  &#x2F;&#x2F;  子服务的 URL
  static String hostAuth &#x3D; &quot;&#x2F;isduapi&#x2F;api&#x2F;auth&quot;;
  static String hostCommonQuery &#x3D; &quot;&#x2F;isduapi&#x2F;api&#x2F;common&quot;;
  static String hostEdu &#x3D; &quot;&#x2F;isduapi&#x2F;api&#x2F;edu&quot;;
  static String hostUser &#x3D; &quot;&#x2F;isduapi&#x2F;infra&#x2F;user&quot;;
  static String hostYiBan &#x3D; &quot;&#x2F;isduapi&#x2F;api&#x2F;yiban&quot;;
  static String hostLibrary &#x3D; &quot;&#x2F;isduapi&#x2F;api&#x2F;library&quot;;
  static String hostTool &#x3D; &#39;&#x2F;isduapi&#x2F;api&#x2F;tool&#39;;

  static String _onlineServerAlive &#x3D; &#39;$&#123;Server.hostCommonQuery&#125;&#x2F;feedback&#x2F;types&#39;;

  &#x2F;&#x2F;检查是否是校园网
  static Future&lt;bool&gt; isSchoolNetwork() async &#123;
    bool _isSchoolNetwork &#x3D; true;
    &#x2F;&#x2F;这个接口只是为了检查是否为内网情况，没有什么特殊意义
    &#x2F;&#x2F;不使用封装的dio，避免被一直重发
    await Dio().get(&#39;http:&#x2F;&#x2F;urp.sdu.edu.cn&#x2F;&#39;).catchError((obj) &#123;
      _isSchoolNetwork &#x3D; false;
    &#125;);
    return _isSchoolNetwork;
  &#125;
&#125;</code></pre></div>
<p>问题来了，我也不知道前面几个接口是干嘛用的。留个坑。</p>
<p>判断校园网的逻辑很简单，发个请求，如果<code>Dio</code>catch到异常就说明不是校园网。</p>
<p><code>api.dart</code>组织了所有API，首先看一下获取的Cookie的API。i山大一共需要获取三个Cookie，分别是<code>serviceCookie</code>、<code>educationCookie</code>和<code>dataCenterCookie</code>，分别对应学校提供的三个主要服务。以获取<code>serviceCookie</code>为例</p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">
&#x2F;&#x2F;&#x2F;Cookie接口
class CookieAPI &#123;
  &#x2F;&#x2F; 组装三个服务的登录URL
  static String _service &#x3D; &#39;$&#123;Server.hostAuth&#125;&#x2F;login&#x2F;service&#39;;
  static String _edu &#x3D; &#39;$&#123;Server.hostAuth&#125;&#x2F;login&#x2F;edu&#39;;
  static String _data &#x3D; &#39;$&#123;Server.hostAuth&#125;&#x2F;login&#x2F;data_center&#39;;

  &#x2F;&#x2F; 异步获取Cookie
  static Future&lt;Map&lt;String, String&gt;&gt; serviceCookie() async &#123;
    Box _hiveBox &#x3D; await Hive.openBox(&#39;pBox&#39;,
        encryptionCipher: HiveAesCipher(
            SecurityUtil.generateKeyByString(UserAPI.curUser.casId)));
    Response response &#x3D; await HttpUtils.post(_service, params: &#123;
      &#39;u&#39;: _hiveBox.get(&#39;u&#39;),
      &#39;p&#39;: _hiveBox.get(&#39;p&#39;),
    &#125;);
    return _generateCookieMap(response.data ?? &#39;&#39;);
  &#125;

  static Future&lt;Map&lt;String, String&gt;&gt; educationCookie() async &#123;
    &#x2F;&#x2F; ...
  &#125;

  static Future&lt;Map&lt;String, String&gt;&gt; dataCenterCookie() async &#123;
    &#x2F;&#x2F; ...
  &#125;

  static Map&lt;String, String&gt; _generateCookieMap(String cookie) &#123;
    Map&lt;String, String&gt; map &#x3D; &#123;&#125;;
    cookie.split(&#39;;&#39;).forEach((element) &#123;
      try &#123;
        if (element.isNotEmpty) &#123;
          Cookie c &#x3D; Cookie.fromSetCookieValue(element ?? &#39;&#39;);
          map[c.name] &#x3D; c.value ?? &#39;&#39;;
        &#125;
      &#125; catch (e) &#123;
        map[element] &#x3D; &#39;&#39;;
      &#125;
    &#125;);
    return map;
  &#125;
&#125;</code></pre></div>
<p>其中</p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">Box _hiveBox &#x3D; await Hive.openBox(
  &#39;pBox&#39;,
  encryptionCipher: HiveAesCipher(
    SecurityUtil.generateKeyByString(
      UserAPI.curUser.casId)));</code></pre></div>
<p>使用<code>Hive</code>的<code>encrptedBox</code>，通过封装的<code>SecurityUtil</code>工具计算AES获得i山大登录信息，并将其装载到URL中通过HttpUtil请求Cookie。</p>
<p>i山大使用这几个方法获取登录Token。其中<code>minorToken</code>是辅修使用的Token。</p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">static Future&lt;String&gt; getToken() async &#123;
  bool isMinor &#x3D; await Store.getBool(&#39;isMinor&#39;) ?? false;
  return isMinor ? await getMinorToken() : await getMainToken();
&#125;

static Future&lt;String&gt; getMinorToken() async &#123;
  String token;
  token &#x3D; await Store.get(&#39;minorToken&#39;);
  return token;
&#125;

static Future&lt;String&gt; getMainToken() async &#123;
  String token;
  token &#x3D; await Store.get(&#39;token&#39;);
  return token;
&#125;</code></pre></div>
<p>使用refreshToken更新Token的方法</p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">&#x2F;&#x2F;&#x2F;获取refresh_token,并存储到数据库中
static Future&lt;bool&gt; refreshTokens() async &#123;
  bool isMinor &#x3D; await Store.getBool(&#39;isMinor&#39;) ?? false;
  String refreshToken &#x3D; isMinor
      ? await Store.getString(&#39;minorRefreshToken&#39;)
      : await Store.getString(&quot;refresh_token&quot;);
  if (refreshToken &#x3D;&#x3D; null || refreshToken.isEmpty) &#123;
    return true;
  &#125;
  Response response &#x3D; await HttpUtils.post(_refresh,
      data: FormData.fromMap(&#123;
        &#39;refresh_token&#39;: refreshToken,
        &#39;k&#39;: await DeviceInfoUtil.getUniqueId()
      &#125;)).catchError((error) &#123;
    LogUtil.log(error, name: &#39;UserAPI.getRefreshToken&#39;);
    return Response(requestOptions: error.requestOptions, data: &#123;
      &#39;code&#39;: -1,
    &#125;);
  &#125;);
  if (response.data[&#39;code&#39;] &#x3D;&#x3D; -1) &#123;
    LogUtil.log(&#39;refreshToken请求异常&#39;, name: &#39;UserAPI.getRefreshToken&#39;);
    return false;
  &#125;
  if (response.data[&#39;code&#39;] &#x3D;&#x3D; 40102) &#123;
    Fluttertoast.showToast(msg: &#39;登录已失效,请退出并重新登录账户&#39;);
    return false;
  &#125;
  var result &#x3D; JsonDecoder().convert(response.toString());
  if (result !&#x3D; null) &#123;
    if (result[&#39;code&#39;] !&#x3D; 0) &#123;
      return true;
    &#125;
    if (isMinor) &#123;
      await Store.set(&#39;minorToken&#39;, result[&#39;data&#39;][0]);
      await Store.set(&#39;minorRefreshToken&#39;, result[&#39;data&#39;][1]);
    &#125; else &#123;
      await Store.set(&#39;token&#39;, result[&#39;data&#39;][0]);
      await Store.set(&#39;refresh_token&#39;, result[&#39;data&#39;][1]);
    &#125;
  &#125; else &#123;
    return true;
  &#125;
  return false;
&#125;</code></pre></div>
<h4 id="使用hive并加密8">使用Hive并加密<sup id="fnref:8" class="footnote-ref"><a href="#fn:8" rel="footnote"><span class="hint--top hint--rounded" aria-label="Encrypted box - Hive
">[8]</span></a></sup></h4>
<p>Sometimes it is necessary to store data securely on the disk. Hive supports <strong>AES-256 encryption</strong> out of the box (literally).</p>
<p>The only thing you need is a <strong>256-bit (32 bytes) encryption key</strong>. Hive provides a helper function to generate a secure encryption key using the Fortuna random number generator.</p>
<div class="code-wrapper"><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart">void main() async &#123;
  const secureStorage &#x3D; FlutterSecureStorage();
  &#x2F;&#x2F; if key not exists return null
  final encryprionKey &#x3D; await secureStorage.read(key: &#39;key&#39;);
  if (encryprionKey &#x3D;&#x3D; null) &#123;
    final key &#x3D; Hive.generateSecureKey();
    await secureStorage.write(
      key: &#39;key&#39;,
      value: base64UrlEncode(key),
    );
  &#125;
  final key &#x3D; await secureStorage.read(key: &#39;key&#39;);
  final encryptionKey &#x3D; base64Url.decode(key!);
  print(&#39;Encryption key: $encryptionKey&#39;);

  final encryptedBox&#x3D; await Hive.openBox(
    &#39;vaultBox&#39;, 
    encryptionCipher: HiveAesCipher(encryptionKey));
  encryptedBox.put(&#39;secret&#39;, &#39;Hive is cool&#39;);
  print(encryptedBox.get(&#39;secret&#39;));
&#125;</code></pre></div>
<h3 id="拦截器">拦截器</h3>
<h2 id="参考资料">参考资料</h2>
<section class="footnotes">
<div class="footnote-list">
<ol>
<li>
<span id="fn:1" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://juejin.cn/post/7031196891358429220">Flutter runApp -- WidgetsFlutterBinding - 掘金</a> <a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩︎</a></span></span>
</li>
<li>
<span id="fn:2" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://stackoverflow.com/q/63873338/19503179">What Does WidgetsFlutterBinding.ensureInitialized() do? - StackOverflow</a> <a href="#fnref:2" rev="footnote" class="footnote-backref"> ↩︎</a></span></span>
</li>
<li>
<span id="fn:3" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://flutter.cn/docs/testing/errors">在Flutter里处理错误</a> <a href="#fnref:3" rev="footnote" class="footnote-backref"> ↩︎</a></span></span>
</li>
<li>
<span id="fn:4" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://book.flutterchina.club/chapter2/thread_model_and_error_report.html">Flutter异常捕获</a> <a href="#fnref:4" rev="footnote" class="footnote-backref"> ↩︎</a></span></span>
</li>
<li>
<span id="fn:5" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://api.flutter-io.cn/flutter/dart-async/runZonedGuarded.html">runZonedGuarded<R> function - Flutter</a> <a href="#fnref:5" rev="footnote" class="footnote-backref"> ↩︎</a></span></span>
</li>
<li>
<span id="fn:6" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://blog.csdn.net/sinat_17775997/article/details/106687888">Flutter onGenerateRoute 路由管理 - CSDN</a> <a href="#fnref:6" rev="footnote" class="footnote-backref"> ↩︎</a></span></span>
</li>
<li>
<span id="fn:7" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://flutter.cn/docs/cookbook/navigation/navigate-with-arguments">给特定的 route 传参 - Flutter</a> <a href="#fnref:7" rev="footnote" class="footnote-backref"> ↩︎</a></span></span>
</li>
<li>
<span id="fn:8" class="footnote-text"><span><a target="_blank" rel="noopener" href="https://docs.hivedb.dev/#/advanced/encrypted_box">Encrypted box - Hive</a> <a href="#fnref:8" rev="footnote" class="footnote-backref"> ↩︎</a></span></span>
</li>
</ol>
</div>
</section>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/blog/categories/%E5%BC%80%E5%8F%91/">开发</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/blog/tags/Flutter/">Flutter</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"8fmElDB8yTQ6Cpsn0mbNbdxd-gzGzoHsz","appKey":"WIsNNq3yinfKJBndF0qqO31p","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":true,"recordIP":false,"serverURLs":"","emojiCDN":"//i0.hdslb.com/bfs/emote/","emojiMaps":{"tv_doge":"6ea59c827c414b4a2955fe79e0f6fd3dcd515e24.png","tv_亲亲":"a8111ad55953ef5e3be3327ef94eb4a39d535d06.png","tv_偷笑":"bb690d4107620f1c15cff29509db529a73aee261.png","tv_再见":"180129b8ea851044ce71caf55cc8ce44bd4a4fc8.png","tv_冷漠":"b9cbc755c2b3ee43be07ca13de84e5b699a3f101.png","tv_发怒":"34ba3cd204d5b05fec70ce08fa9fa0dd612409ff.png","tv_发财":"34db290afd2963723c6eb3c4560667db7253a21a.png","tv_可爱":"9e55fd9b500ac4b96613539f1ce2f9499e314ed9.png","tv_吐血":"09dd16a7aa59b77baa1155d47484409624470c77.png","tv_呆":"fe1179ebaa191569b0d31cecafe7a2cd1c951c9d.png","tv_呕吐":"9f996894a39e282ccf5e66856af49483f81870f3.png","tv_困":"241ee304e44c0af029adceb294399391e4737ef2.png","tv_坏笑":"1f0b87f731a671079842116e0991c91c2c88645a.png","tv_大佬":"093c1e2c490161aca397afc45573c877cdead616.png","tv_大哭":"23269aeb35f99daee28dda129676f6e9ea87934f.png","tv_委屈":"d04dba7b5465779e9755d2ab6f0a897b9b33bb77.png","tv_害羞":"a37683fb5642fa3ddfc7f4e5525fd13e42a2bdb1.png","tv_尴尬":"7cfa62dafc59798a3d3fb262d421eeeff166cfa4.png","tv_微笑":"70dc5c7b56f93eb61bddba11e28fb1d18fddcd4c.png","tv_思考":"90cf159733e558137ed20aa04d09964436f618a1.png","tv_惊吓":"0d15c7e2ee58e935adc6a7193ee042388adc22af.png"},"enableQQ":true},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          Fluid.plugins.initFancyBox('#valine .vcontent img:not(.vemoji)');
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div style="font-size: 0.85rem"> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div>
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/blog/js/events.js" ></script>
<script  src="/blog/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/blog/js/local-search.js" ></script>



  
    <script  src="/blog/js/img-lazyload.js" ></script>
  



  
    
      <script  src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-core.min.js" ></script>
      <script  src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js" ></script>
      
        <script  src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/line-numbers/prism-line-numbers.min.js" ></script>
      
    
  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>





  

  
    <!-- MathJax -->
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        loader: {
          load: ['ui/lazy']
        },
        options: {
          renderActions: {
            findScript: [10, doc => {
              document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                const display = !!node.type.match(/; *mode=display/);
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                const text = document.createTextNode('');
                node.parentNode.replaceChild(text, node);
                math.start = { node: text, delim: '', n: 0 };
                math.end = { node: text, delim: '', n: 0 };
                doc.math.push(math);
              });
            }, '', false],
            insertedScript: [200, () => {
              document.querySelectorAll('mjx-container').forEach(node => {
                let target = node.parentNode;
                if (target.nodeName.toLowerCase() === 'li') {
                  target.parentNode.classList.add('has-jax');
                }
              });
            }, '', false]
          }
        }
      };
    </script>

    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" ></script>

  








  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?5b545cafb70936459694733c37bcf02c";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/blog/js/boot.js" ></script>


<!-- hexo injector body_end start -->
  <script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/hexo-github-calendar@1.21/hexo_githubcalendar.js"></script>
  <script data-pjax>
        function GithubCalendarConfig(){
            var git_githubapiurl ="https://python-github-calendar-api.vercel.app/api?zghehejun233";
            var git_color =['#ebedf0', '#f1f8ff', '#dbedff', '#c8e1ff', '#79b8ff', '#2188ff', '#0366d6', '#005cc5', '#044289', '#032f62', '#05264c'];
            var git_user ="zghehejun233";
            var parent_div_git = document.getElementById('recent-posts');
            var git_div_html = '<div id="github-calendar" style="width:100%;height:auto;padding:10px;margin-bottom:20px"><div id="github_loading" style="width:10%;height:100%;margin:0 auto;display: block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform></path></svg></div><div id="github_container"></div></div>';
            if(parent_div_git && location.pathname =='/blog/about'){
                console.log('已挂载github calendar')
                // parent_div_git.innerHTML=git_div_html+parent_div_git.innerHTML // 无报错，但不影响使用(支持pjax跳转)
                parent_div_git.insertAdjacentHTML("afterbegin",git_div_html) // 有报错，但不影响使用(支持pjax跳转)
            };
            GithubCalendar(git_githubapiurl,git_color,git_user)
        }
        if(document.getElementById('recent-posts')){
            GithubCalendarConfig()
        }
    </script>
    <style>#github_container{min-height:200px}@media screen and (max-width:650px) {#github_container{background-image:;min-height:0px}}</style>
    <style>#github_container > .position-relative > .border{border:0!important}#github-calendar{position: relative;margin-top: -2rem;background-color: var(--board-bg-color);transition: background-color 0.2s ease-in-out;border-radius: 0.5rem;z-index: 3;-webkit-box-shadow: 0 12px 15px 0 rgb(0 0 0 / 24%), 0 17px 50px 0 rgb(0 0 0 / 19%);box-shadow: 0 12px 15px 0 rgb(0 0 0 / 24%), 0 17px 50px 0 rgb(0 0 0 / 19%);}</style><!-- hexo injector body_end end --></body>
</html>
